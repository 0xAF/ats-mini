Major code refactoring: split code into modules, get rid of global variables, etc. Huge thanks to Marat Faizulling for doing the heavy lifting.
